# ============================================================
# CertVoice — Wrangler Configuration
#
# Deploys all Cloudflare Workers for CertVoice.
# Each worker is defined as a separate environment.
#
# Usage: Deployed via GitHub Action on push to main.
#        Each worker deploys independently.
#
# R2 Bucket: certvoice-storage (create in CF dashboard first)
#
# Secrets (set via CF dashboard → Workers → Settings → Variables):
#   DATABASE_URL, ANTHROPIC_API_KEY, STRIPE_SECRET_KEY,
#   STRIPE_WEBHOOK_SECRET, UPSTASH_REDIS_REST_URL,
#   UPSTASH_REDIS_REST_TOKEN, CLERK_JWKS_URL
#
# ============================================================

name = "certvoice-workers"
compatibility_date = "2024-12-01"
main = "workers/index.ts"

# ---- Shared vars (non-secret, override per-environment if needed) ----
[vars]
ALLOWED_ORIGIN = "https://certvoice.co.uk"
STRIPE_PRICE_ID = ""

# ---- R2 Bucket binding (shared across workers) ----
[[r2_buckets]]
binding = "SIGNATURES_BUCKET"
bucket_name = "certvoice-storage"

[[r2_buckets]]
binding = "STORAGE_BUCKET"
bucket_name = "certvoice-storage"

# ============================================================
# WORKER ENVIRONMENTS
# Deploy individually: wrangler deploy --env <name>
# ============================================================

# --- 1. Claude Proxy (AI extraction) ---
[env.claude-proxy]
name = "certvoice-claude-proxy"
main = "workers/claude-proxy.ts"

# --- 2. PDF Generator ---
[env.pdf-generate]
name = "certvoice-pdf-generate"
main = "workers/pdf-generate.ts"

[[env.pdf-generate.r2_buckets]]
binding = "STORAGE_BUCKET"
bucket_name = "certvoice-storage"

# --- 3. R2 Upload (photos & signatures) ---
[env.r2-upload]
name = "certvoice-r2-upload"
main = "workers/r2-upload.ts"

[[env.r2-upload.r2_buckets]]
binding = "BUCKET"
bucket_name = "certvoice-storage"

# --- 4. Engineer Settings ---
[env.engineer-settings]
name = "certvoice-engineer-settings"
main = "workers/engineer-settings.ts"

[[env.engineer-settings.r2_buckets]]
binding = "SIGNATURES_BUCKET"
bucket_name = "certvoice-storage"

# --- 5. Stripe Subscription ---
[env.stripe-subscription]
name = "certvoice-stripe-subscription"
main = "workers/stripe-subscription.ts"

# --- 6. Certificates CRUD ---
[env.certificates-crud]
name = "certvoice-certificates-crud"
main = "workers/certificates-crud.ts"
